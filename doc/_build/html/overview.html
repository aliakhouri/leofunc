

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Functional Directives in Leo &mdash; leofunc 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="leofunc 0.1 documentation" href="index.html" />
    <link rel="next" title="Functional-Leo Modules" href="modules/index.html" />
    <link rel="prev" title="Functional-Leo Documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="modules/index.html" title="Functional-Leo Modules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Functional-Leo Documentation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">leofunc 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Functional Directives in Leo</a></li>
<li><a class="reference internal" href="#a-graphical-walkthrough">A Graphical Walkthrough</a><ul>
<li><a class="reference internal" href="#the-basic-elements">The Basic Elements</a></li>
<li><a class="reference internal" href="#text-and-namespaces">Text and Namespaces</a></li>
<li><a class="reference internal" href="#the-analytical-outcome">The Analytical Outcome</a></li>
<li><a class="reference internal" href="#the-big-picture">The Big Picture</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-patterns">Usage Patterns</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#tutorial">Tutorial</a></li>
<li><a class="reference internal" href="#illustrative-examples">Illustrative Examples</a><ul>
<li><a class="reference internal" href="#py-and-pyc">&#64;py and &#64;pyc</a></li>
<li><a class="reference internal" href="#imports">&#64;imports</a></li>
<li><a class="reference internal" href="#rss">&#64;rss</a></li>
<li><a class="reference internal" href="#pipe">&#64;pipe</a></li>
<li><a class="reference internal" href="#csum">&#64;csum</a></li>
</ul>
</li>
<li><a class="reference internal" href="#known-issues">Known Issues</a><ul>
<li><a class="reference internal" href="#poor-integration-with-leo">Poor integration with Leo</a></li>
<li><a class="reference internal" href="#whitespace-prohibited-in-a-directive-call">Whitespace prohibited in a directive call</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Functional-Leo Documentation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="modules/index.html"
                        title="next chapter">Functional-Leo Modules</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/overview.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="functional-directives-in-leo">
<h1>Functional Directives in Leo<a class="headerlink" href="#functional-directives-in-leo" title="Permalink to this headline">¶</a></h1>
<p><strong>leo directives as python callables</strong></p>
<p>This document explores a concept for <a class="reference external" href="http://webpages.charter.net/edreamleo/front.html">leo-editor</a> which aims to collapse the distinction between <a class="reference external" href="http://webpages.charter.net/edreamleo/intro.html#leo-directives">leo directives</a> and python callables.</p>
<p><strong>Why would one want to do this?</strong></p>
<p>To add even more power to Leo of course (-:</p>
<p>Here are some possible benefits:</p>
<ul class="simple">
<li>Makes it easier to create custom directives in a leo document.</li>
<li>Adds a new dimension of scriptability to leo: directives are callables, they have access to the full power of python programming;</li>
<li>Since callables can also be part of a module or namespace, it will be easier to group useful directives into libraries.</li>
<li>A leo head or body can have multiple &#8216;views&#8217; which are rendered as a result of evaluating its embedded code.</li>
<li>Easily create text/tree transformers in leo using functional pipelines.</li>
<li>Simplifies batch pre/processing/piping of data in leo nodes (for macros, templates, leoapps? ..)</li>
<li>Makes it easier to create Domain Specific Languages [DSLs]</li>
<li>&lt;add more benefits&gt;</li>
</ul>
<p>Since this particular conception of leo directives mostly operate in a functional way on leo elements, we call them <em>functional directives</em>.</p>
<p>These types of directives are implemented as a python callable with a particular signature that gets registered by the <a class="reference internal" href="modules/leofunc.html#leofunc.directive" title="leofunc.directive"><tt class="xref py py-obj docutils literal"><span class="pre">leofunc.directive</span></tt></a> decorator.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is merely a simulation. We have not yet really considered compatibility issues, current implementation details of leo, or how the functional directives will work with the current style of leo directives.</p>
</div>
<p>This model only works in a much-simplified simulation of leo implemented in <a class="reference internal" href="modules/leofunc.html#module-leofunc" title="leofunc: a simulation of the suggested functionality."><tt class="xref py py-mod docutils literal"><span class="pre">leofunc</span></tt></a> and tested in <a class="reference internal" href="modules/test_leofunc.html#module-test_leofunc" title="test_leofunc: tests of the functionality."><tt class="xref py py-mod docutils literal"><span class="pre">test_leofunc</span></tt></a>. Alas, I still do not converse well with Leo&#8217;s innards, so this really is (at this stage) just an extended thought exercise with code. If there is support for this concept, I would appreciate any help to integrate it more closely with leo.</p>
<p>Documentation has been generated from reStructuredText source markup using a combination of <a class="reference external" href="http://webpages.charter.net/edreamleo/front.html">leo-editor</a> and <a class="reference external" href="http://sphinx.pocoo.org/">Sphinx</a></p>
</div>
<div class="section" id="a-graphical-walkthrough">
<h1>A Graphical Walkthrough<a class="headerlink" href="#a-graphical-walkthrough" title="Permalink to this headline">¶</a></h1>
<p>Since we are introducing a simplified model of leo, it may be useful to have a look at some of its elements in a graphical way ( a great excuse to use Sphinx&#8217;s cool graphing feature :-)</p>
<div class="section" id="the-basic-elements">
<h2>The Basic Elements<a class="headerlink" href="#the-basic-elements" title="Permalink to this headline">¶</a></h2>
<p>An element is part of a node is part of a tree.</p>
<p class="graphviz">
<img src="_images/graphviz-d5c21a29fa019a52d4e6a99b448385bb1b19a773.png" alt="digraph a {

    node [fontsize=10, fontname=Helvetica];
    &quot;element&quot; -&gt; &quot;node&quot;;
    &quot;node&quot; -&gt; &quot;node&quot;;
    &quot;node&quot; -&gt; &quot;tree&quot;;
}" />
</p>
</div>
<div class="section" id="text-and-namespaces">
<h2>Text and Namespaces<a class="headerlink" href="#text-and-namespaces" title="Permalink to this headline">¶</a></h2>
<p>The key thing about an element is that it stores raw text that can be parsed. If correctly parsed, it can be evaluated in the context of two python namespaces (the node-specific or &#8216;local&#8217; namespace and the tree namespace, which is commonly accessible or &#8216;global&#8217; to all elements in the tree.</p>
<p class="graphviz">
<img src="_images/graphviz-f6431965b6138bb0d4a517751d9ca97a2f6dd179.png" alt="digraph c {

    node [fontsize=10, fontname=Helvetica];
    &quot;element&quot; -&gt; &quot;node&quot;;
    &quot;element&quot; -&gt; &quot;element.text&quot;;
    &quot;node&quot; -&gt; &quot;node&quot;;
    &quot;node&quot; -&gt; &quot;node.namespace&quot;;
    &quot;node&quot; -&gt; &quot;tree&quot;;
    &quot;tree&quot; -&gt; &quot;tree.namespace&quot;;
}" />
</p>
</div>
<div class="section" id="the-analytical-outcome">
<h2>The Analytical Outcome<a class="headerlink" href="#the-analytical-outcome" title="Permalink to this headline">¶</a></h2>
<p>When an element is created its text is parsed to populate its directive, code and data attributes.</p>
<p class="graphviz">
<img src="_images/graphviz-5ca7a00b492ab5461843456491e375f7c5672ec4.png" alt="digraph d {

    node [fontsize=8, fontname=Helvetica];
    &quot;element&quot; -&gt; &quot;node&quot;;
    &quot;element&quot; -&gt; &quot;element.text&quot;;
    &quot;element&quot; -&gt; &quot;element.directive&quot;;
    &quot;element&quot; -&gt; &quot;element.code&quot;;
    &quot;element&quot; -&gt; &quot;element.data&quot;;
    &quot;node&quot; -&gt; &quot;node&quot;;
    &quot;node&quot; -&gt; &quot;node.namespace&quot;;
    &quot;node&quot; -&gt; &quot;tree&quot;;
    &quot;tree&quot; -&gt; &quot;tree.namespace&quot;;
}" />
</p>
</div>
<div class="section" id="the-big-picture">
<h2>The Big Picture<a class="headerlink" href="#the-big-picture" title="Permalink to this headline">¶</a></h2>
<p>In the context of leo, an element is either a head or body of a node.</p>
<p class="graphviz">
<img src="_images/graphviz-e43307f9e689abf0781c458cb1d95c12813e041c.png" alt="digraph e {

    node [fontsize=8, fontname=Helvetica];

    &quot;node&quot; -&gt; &quot;head&quot;;
    &quot;head&quot; -&gt; &quot;head.directive&quot;;
    &quot;head&quot; -&gt; &quot;head.code&quot;;
    &quot;head&quot; -&gt; &quot;head.data&quot;;
    &quot;head&quot; -&gt; &quot;head.text&quot;;

    &quot;node&quot; -&gt; &quot;body&quot;;
    &quot;body&quot; -&gt; &quot;body.directive&quot;;
    &quot;body&quot; -&gt; &quot;body.code&quot;;
    &quot;body&quot; -&gt; &quot;body.data&quot;;
    &quot;body&quot; -&gt; &quot;body.text&quot;;

    &quot;node&quot; -&gt; &quot;node&quot;;
    &quot;node&quot; -&gt; &quot;node.namespace&quot;;

    &quot;node&quot; -&gt; &quot;tree&quot;;
    &quot;tree&quot; -&gt; &quot;tree.namespace&quot;;
}" />
</p>
</div>
</div>
<div class="section" id="usage-patterns">
<h1>Usage Patterns<a class="headerlink" href="#usage-patterns" title="Permalink to this headline">¶</a></h1>
<p>A leo functional directive has two <em>tentative</em> forms:</p>
<p>The first is the single line version:</p>
<div class="highlight-python"><pre>@&lt;directive&gt; &lt;code&gt;</pre>
</div>
<p>The second form is for block or suite versions and are possible only for body elements:</p>
<div class="highlight-python"><pre>@&lt;directive&gt;
&lt;code&gt;
@
&lt;data&gt;</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">&lt;directive&gt;</span></tt> is implemented as a python callable that is either in a <tt class="xref py py-attr docutils literal"><span class="pre">leofunc.Tree.namespace</span></tt> or in a <tt class="xref py py-attr docutils literal"><span class="pre">leofunc.Node.namespace</span></tt>. Heads and bodies share a common <tt class="xref py py-attr docutils literal"><span class="pre">leofunc.Node.namespace</span></tt>.</p>
<p>In the single line version of a directive, <tt class="docutils literal"><span class="pre">&lt;code&gt;</span></tt> is a string that follows the <tt class="docutils literal"><span class="pre">&lt;directive&gt;</span></tt> and is terminated by <tt class="docutils literal"><span class="pre">\n</span></tt>.</p>
<p>In the body version, <tt class="docutils literal"><span class="pre">&lt;code&gt;</span></tt> consists of all <tt class="docutils literal"><span class="pre">\n</span></tt> terminated strings which extend from the end of the first line (containing the directive) and finally terminate with <tt class="docutils literal"><span class="pre">\n&#64;\n</span></tt>. The <tt class="docutils literal"><span class="pre">&lt;data&gt;</span></tt> section is everything that follows.</p>
<p>Obviously, we can only have the single line version in a head (or headline), but both forms can happily exist in the body of a node.</p>
</div>
<div class="section" id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h1>
<p>A leo functional directive is implemented as a python callable returning a callable accepting a leo element.</p>
<p>A leo element is an instance of <a class="reference internal" href="modules/leofunc.html#leofunc.Element" title="leofunc.Element"><tt class="xref py py-class docutils literal"><span class="pre">leofunc.Element</span></tt></a> (a head or a body object) contained in a <a class="reference internal" href="modules/leofunc.html#leofunc.Node" title="leofunc.Node"><tt class="xref py py-class docutils literal"><span class="pre">leofunc.Node</span></tt></a> instance.</p>
<p>This basic example defines a function <tt class="docutils literal"><span class="pre">func</span></tt> which implements a directive <tt class="docutils literal"><span class="pre">&#64;elem</span></tt> registered by the <a class="reference internal" href="modules/leofunc.html#leofunc.directive" title="leofunc.directive"><tt class="xref py py-obj docutils literal"><span class="pre">leofunc.directive</span></tt></a> decorator. The purpose of this directive is to simply return the element from which it is called:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@directive</span><span class="p">(</span><span class="s">&#39;elem&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_func</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">element</span>
    <span class="k">return</span> <span class="n">_func</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To create a directive which takes optional arguments is to define both <tt class="docutils literal"><span class="pre">*args</span></tt> and <tt class="docutils literal"><span class="pre">**kwds</span></tt> or just <tt class="docutils literal"><span class="pre">**kwds</span></tt>. Note that we cannot presently define funcs which do not take parameters. Even if optional args or kwds are not eventually used in the function, this specific signature is required for this implementation.</p>
</div>
<p>There is a more concise but less readable lambda version:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">func</span> <span class="o">=</span> <span class="n">directive</span><span class="p">(</span><span class="s">&#39;elem&#39;</span><span class="p">)(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">element</span><span class="p">:</span> <span class="n">element</span><span class="p">)</span>
</pre></div>
</div>
<p>We could use this directive in a leo tree as follows:</p>
<div class="highlight-python"><pre>+-- root
     |
     +-- @elem
     |
     +-- @elem(a,b,c='value')
     |
     +-- @elem
     |</pre>
</div>
<p>but it&#8217;s not very useful at this stage since evaluating this directive will always return the head object for each case.</p>
</div>
<div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>Now to do something useful: the obligatory hello world as a leo functional directive.</p>
<p>In a directory containing <tt class="file docutils literal"><span class="pre">leofunc.py</span></tt> fire up python or ipython and enter this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">leofunc</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">directive</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nd">@directive</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;hello-expr&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">eval_hello</span><span class="p">(</span><span class="n">world</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">_eval_hello</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s">&#39;hello </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">world</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">_eval_hello</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="s">&quot;@hello(&#39;leo&#39;)&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span>
<span class="go"> &lt;Node  [@hello(&#39;leo&#39;)]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">directive</span>
<span class="go">&quot;hello(&#39;leo&#39;)&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">code</span>
<span class="go">&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">data</span>
<span class="go">&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">text</span>
<span class="go">&quot;@hello(&#39;leo&#39;)&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">type</span>
<span class="go">&#39;hello-expr&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">view</span>
<span class="go">hello leo</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="illustrative-examples">
<h1>Illustrative Examples<a class="headerlink" href="#illustrative-examples" title="Permalink to this headline">¶</a></h1>
<p>The following examples of custom functional directives are implemented in <tt class="file docutils literal"><span class="pre">leofunc.py</span></tt> and tested in <tt class="file docutils literal"><span class="pre">test_leofunc.py</span></tt>. Both files include further examples and tests of other leo directives. Of course, you can just look at the code section of <tt class="file docutils literal"><span class="pre">code.leo</span></tt>.</p>
<div class="section" id="py-and-pyc">
<h2>&#64;py and &#64;pyc<a class="headerlink" href="#py-and-pyc" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s start with some code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">leofunc</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">head</span><span class="o">=</span><span class="s">&#39;@py 1+1+a&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s">&#39;@pyc a=2&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># we render body first to populate node.namespace</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># and give the head access to the &#39;a&#39; variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">directive</span>
<span class="go">&#39;py&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">code</span>
<span class="go">&#39;1+1+a&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">data</span>
<span class="go">&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">view</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">directive</span>
<span class="go">&#39;pyc&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">type</span>
<span class="go">&#39;py-suite&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">code</span>
<span class="go">&#39;a=2&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">view</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="s">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">namespace</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>In this case, we have defined a <tt class="docutils literal"><span class="pre">py-expr</span></tt> or python expression for the head of a node and a <tt class="docutils literal"><span class="pre">py-suite</span></tt> or python code block for its body.</p>
<p>It may be useful to briefly look into the implementation of &#64;py</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@directive</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s">&#39;py&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;py-expr&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_py_expression</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; creates and registers a @py directive</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_eval_py_expression</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_eval_py_expression</span>
</pre></div>
</div>
<p>The &#64;directive decorator registers this function in a global dictionary called DIRECTIVES. The eval_py_expression function takes optional keyword arguments which update the namespace and returns a function which operates on a leo element. This is the signature for a leo functional directive. It must (as a matter of mere implementation) accept only elements, which are the typical subcomponents of a LeoNode (e.g. head and body). This is not a loss since element-level code can theoretically climb up or down the tree and access any other node.</p>
<p>The <tt class="docutils literal"><span class="pre">&#64;py</span></tt> directive which allows us to evaluate arbitrary python expressions which may or may not return data and treat parts of a leo outline as a kind of program:</p>
<div class="highlight-python"><pre>+-- root
     |
     +-- @py sum(child.head.view for child in node.children)
     |         |
     |         +-- @py len(node.parent.children)
     |         |
     |         +-- @py(a=1) 1 + a
     |         |
     |         +-- @py 100</pre>
</div>
<p>If we were to evaluate or view the <tt class="docutils literal"><span class="pre">&#64;py</span> <span class="pre">sum(..)</span></tt> node we would get 105 as an int result.  One can imagine uses along the lines of a tree-based spreadsheet, command-tree, script collection, etc..</p>
<p>Perhaps the above example looks wordy, but that&#8217;s because we&#8217;re trying to be explicit and illustrative of different possible forms. The &#64;csum directive, which is defined later in this section, implements a custom child-summing function which allows for a more concise style.</p>
<p>The other functional directive that is being used above is <tt class="docutils literal"><span class="pre">&#64;pyc</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@directive</span><span class="p">(</span><span class="s">&#39;pyc&#39;</span><span class="p">,</span> <span class="s">&#39;py-suite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_py_suite</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; creates and registers an @pyc directive</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_eval_py_suite</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">exec</span> <span class="n">element</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">namespace</span>
    <span class="k">return</span> <span class="n">_eval_py_suite</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">&#64;pyc</span></tt> creates a python suite or block of code which gets executed in the node&#8217;s namespace.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As you have probably noticed the implementation of this concept embraces eval and exec of arbitrary code in a leo tree. Although this has its dangers, code evaluation is an explicit request from the user who should know that running bits of a leo tree is as dangerous as running other people&#8217;s python code.</p>
</div>
</div>
<div class="section" id="imports">
<h2>&#64;imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<p>&#64;imports updates the tree.namespace with objects and data which are accessible by all instances of LeoNode.</p>
<p>A shortened synonym for this directive is &#64;pg or python-global.</p>
<p>All LeoElements have access to the &#64;imports node&#8217;s namespace during the evaluation or execution of code. It is implemented as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># evaluator functions as directives</span>
<span class="nd">@directive</span><span class="p">(</span><span class="s">&#39;imports&#39;</span><span class="p">,</span> <span class="s">&#39;py-imports&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_py_imports</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_eval_py_imports</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="n">element</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">exec</span> <span class="n">element</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">namespace</span>
    <span class="k">return</span> <span class="n">_eval_py_imports</span>
</pre></div>
</div>
<p>We see that the block of python code is <tt class="docutils literal"><span class="pre">exec</span></tt>&#8216;ed in the tree namespace.</p>
</div>
<div class="section" id="rss">
<h2>&#64;rss<a class="headerlink" href="#rss" title="Permalink to this headline">¶</a></h2>
<p>Here&#8217;s a trivial example of a directive which dumps an rss feed into the default view</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@directive</span><span class="p">(</span><span class="s">&#39;rss&#39;</span><span class="p">,</span> <span class="s">&#39;rss-feed&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_rss</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; creates and registers an @rss directive</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_eval_rss</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">urllib</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">feed</span>
    <span class="k">return</span> <span class="n">_eval_rss</span>
</pre></div>
</div>
<p>We can then use this directive as follows:</p>
<div class="highlight-python"><pre>+-- root
     |
     +-- @rss http://planet.python.org/rss10.xml
     |
     |</pre>
</div>
</div>
<div class="section" id="pipe">
<h2>&#64;pipe<a class="headerlink" href="#pipe" title="Permalink to this headline">¶</a></h2>
<p>We would like to introduce &#64;pipe which look like this:</p>
<div class="highlight-python"><pre>@pipe node.children | sorted | to.children</pre>
</div>
<p>which is exactly equivalent to:</p>
<div class="highlight-python"><pre>@py to.children(sorted(node.children))</pre>
</div>
<p>this should just work as well:</p>
<div class="highlight-python"><pre>@py node.children.sort()</pre>
</div>
<p>Of course, you could just wrap all the above functionality into a single directive and call it &#64;sort:</p>
<div class="highlight-python"><pre>@sort</pre>
</div>
<p>Look in <tt class="docutils literal"><span class="pre">test_leofunc.py</span></tt> for further examples of &#64;pipe usage.</p>
</div>
<div class="section" id="csum">
<h2>&#64;csum<a class="headerlink" href="#csum" title="Permalink to this headline">¶</a></h2>
<p>Following from the earlier &#64;py example, we create a custom &#64;csum directive which can be used this way:</p>
<div class="highlight-python"><pre>+-- root
     |
     +-- @csum sandwhich
     |     |
     |     +-- bread = 100
     |     |
     |     +-- beetroots = 16
     |     |
     |     +-- pigeon = 20
     |</pre>
</div>
<p>The &#64;csum node renders (or evaluates) to 136 by creating a dictionary called &#8216;sandwhich&#8217; in node.namespace and summing its values. This directive is implemented in this messy function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@directive</span><span class="p">(</span><span class="s">&#39;csum&#39;</span><span class="p">,</span> <span class="s">&#39;csum-expr&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_csum</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_eval_csum</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="n">sumd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">namespace</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">view</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">view</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">assigns</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="k">exec</span> <span class="n">assigns</span> <span class="ow">in</span> <span class="n">d</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;__builtins__&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sumd</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_eval_csum</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="known-issues">
<h1>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h1>
<div class="section" id="poor-integration-with-leo">
<h2>Poor integration with Leo<a class="headerlink" href="#poor-integration-with-leo" title="Permalink to this headline">¶</a></h2>
<p>Open Questions:</p>
<ul class="simple">
<li>Is this a good idea?</li>
<li>If so, how to properly introduce leo directives into leo: at what level of integration and in what form?</li>
<li>Script/Button/Command?</li>
<li>Seamlessly?</li>
<li>If not, then perhaps different symbol to not confuse with current implementation?</li>
<li>Drop it. (-:</li>
</ul>
<p>In any case, initial efforts to integrate the concept into Leo proper have only produced a small number of very limited leo scripts which are contained in <tt class="file docutils literal"><span class="pre">code.leo</span></tt>:</p>
<p><strong>tree transformations</strong></p>
<p><tt class="docutils literal"><span class="pre">s1</span></tt>: populates a proper leo node from a predefined tree (bug/feature: skips first node)</p>
<p><tt class="docutils literal"><span class="pre">s2</span></tt>: attempt at a class-based version of <tt class="docutils literal"><span class="pre">s1</span></tt></p>
<p><strong>simulation</strong></p>
<p>This is a nice way to see how leo nodes defined with functional directives would look like. The leo script recursively iterates over the child nodes and creates functional nodes for testing.</p>
</div>
<div class="section" id="whitespace-prohibited-in-a-directive-call">
<h2>Whitespace prohibited in a directive call<a class="headerlink" href="#whitespace-prohibited-in-a-directive-call" title="Permalink to this headline">¶</a></h2>
<p>If you are passing arguments to a directive you <strong>cannot</strong> include whitespace in the call:</p>
<div class="highlight-python"><pre>@py(a=1, b=2)</pre>
</div>
<p>This is due to current limitations of the parser (any help would be appreciated :-)</p>
<p>You will have to write it this way:</p>
<div class="highlight-python"><pre>@py(a=1,b=2)</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="modules/index.html" title="Functional-Leo Modules"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Functional-Leo Documentation"
             >previous</a> |</li>
        <li><a href="index.html">leofunc 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Alia Khouri.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>